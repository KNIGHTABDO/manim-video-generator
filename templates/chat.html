{% extends "base.html" %} {% block title %}MathsGPT Chat - AI Mathematical
Assistant{% endblock %} {% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
  <!-- Chat Header -->
  <div class="text-center mb-12 relative">
    <div class="mb-8">
      <h1 class="text-5xl md:text-7xl font-bold title-font mb-6">
        <span class="gradient-text">MathsGPT Chat</span>
      </h1>
      <div class="flex justify-center items-center space-x-4 mb-6">
        <div
          class="h-px w-20 bg-gradient-to-r from-transparent to-cyan-400"
        ></div>
        <div class="text-cyan-400 text-xl title-font tracking-[0.3em]">
          AI ASSISTANT
        </div>
        <div
          class="h-px w-20 bg-gradient-to-l from-transparent to-cyan-400"
        ></div>
      </div>
      <p
        class="text-xl md:text-2xl text-gray-300 max-w-4xl mx-auto leading-relaxed"
      >
        Chat with our AI about
        <span class="text-cyan-400 font-semibold"
          >mathematics, create videos,</span
        >
        and get instant help with any mathematical concept
      </p>
    </div>
  </div>

  <!-- Chat Container -->
  <div class="max-w-6xl mx-auto">
    <div
      class="glass-card rounded-2xl neon-border overflow-hidden"
      style="height: 70vh"
    >
      <!-- Chat Messages Area -->
      <div class="flex flex-col h-full">
        <!-- Messages Container -->
        <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
          <!-- Welcome Message -->
          <div class="flex items-start space-x-3">
            <div
              class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center flex-shrink-0"
            >
              <i class="fas fa-robot text-black text-sm"></i>
            </div>
            <div class="glass-card rounded-2xl p-4 max-w-md">
              <div class="text-sm text-cyan-400 font-semibold mb-1">
                MathsGPT
              </div>
              <div class="text-white">
                👋 Hello! I'm your AI mathematics assistant. I can help you
                with:
                <ul class="mt-2 space-y-1 text-sm text-gray-300">
                  <li>• Mathematical explanations and tutorials</li>
                  <li>• Solving complex problems step-by-step</li>
                  <li>• Creating animated videos of concepts</li>
                  <li>• Generating Manim code</li>
                </ul>
                <div class="mt-3 text-sm text-cyan-400">
                  💡 Try asking me to create a video by clicking the video
                  button!
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Input Area -->
        <div class="border-t border-cyan-400 border-opacity-30 p-6">
          <div class="flex items-end space-x-4">
            <!-- Message Input -->
            <div class="flex-1">
              <textarea
                id="messageInput"
                placeholder="Ask me anything about mathematics, or request a video animation..."
                class="w-full px-4 py-3 futuristic-input rounded-xl text-white placeholder-gray-400 text-base code-font resize-none"
                rows="1"
                maxlength="2000"
              ></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-2">
              <!-- Video Mode Toggle -->
              <button
                id="videoModeBtn"
                class="example-btn px-4 py-3 rounded-xl font-semibold flex items-center space-x-2 transition-all duration-300"
                title="Toggle Video Creation Mode"
              >
                <i class="fas fa-video"></i>
                <span class="hidden sm:inline">Video</span>
              </button>

              <!-- Send Button -->
              <button
                id="sendBtn"
                class="holo-btn px-6 py-3 rounded-xl font-semibold flex items-center space-x-2"
              >
                <i class="fas fa-paper-plane"></i>
                <span class="hidden sm:inline">Send</span>
              </button>
            </div>
          </div>

          <!-- Video Mode Indicator -->
          <div
            id="videoModeIndicator"
            class="hidden mt-3 flex items-center space-x-2 text-sm"
          >
            <div class="w-3 h-3 bg-purple-400 rounded-full pulse-dot"></div>
            <span class="text-purple-400 font-semibold"
              >Video Creation Mode Active</span
            >
            <span class="text-gray-400"
              >- Your next message will create an animated video</span
            >
          </div>

          <!-- Character Counter -->
          <div
            class="flex justify-between items-center mt-2 text-xs text-gray-400"
          >
            <div class="flex items-center space-x-4">
              <span>Press Ctrl+Enter to send</span>
              <span>|</span>
              <span>Shift+Enter for new line</span>
            </div>
            <span id="charCounter">0/2000</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <button
        class="quick-action-btn"
        data-message="Explain the concept of derivatives"
      >
        <i class="fas fa-chart-line mb-2"></i>
        <span>Derivatives</span>
      </button>
      <button
        class="quick-action-btn"
        data-message="Show me how integration works"
      >
        <i class="fas fa-area-chart mb-2"></i>
        <span>Integration</span>
      </button>
      <button
        class="quick-action-btn"
        data-message="Create a video about the unit circle"
        data-video="true"
      >
        <i class="fas fa-video mb-2"></i>
        <span>Unit Circle Video</span>
      </button>
      <button
        class="quick-action-btn"
        data-message="Explain complex numbers in detail"
      >
        <i class="fas fa-compass mb-2"></i>
        <span>Complex Numbers</span>
      </button>
    </div>
  </div>
</div>

<!-- Video Generation Modal -->
<div
  id="videoModal"
  class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 hidden"
>
  <div class="flex items-center justify-center min-h-screen p-4">
    <div
      class="glass-card rounded-2xl neon-border p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto"
    >
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold title-font text-cyan-400">
          <i class="fas fa-video mr-2"></i>Video Generation
        </h3>
        <button
          id="closeVideoModal"
          class="text-gray-400 hover:text-white text-2xl"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Video Generation Content -->
      <div id="videoModalContent">
        <!-- Content will be dynamically inserted here -->
      </div>
    </div>
  </div>
</div>

<style>
  .quick-action-btn {
    @apply glass-card rounded-xl p-4 text-center text-cyan-400 hover:text-white transition-all duration-300 cursor-pointer;
    @apply flex flex-col items-center justify-center space-y-2;
    @apply border border-cyan-400 border-opacity-30 hover:border-opacity-100;
    @apply transform hover:scale-105 hover:shadow-lg hover:shadow-cyan-400/20;
  }

  .quick-action-btn:hover {
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
  }

  .message-user {
    @apply flex justify-end;
  }

  .message-user .message-content {
    @apply bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-2xl p-4 max-w-md;
  }

  .message-ai {
    @apply flex items-start space-x-3;
  }

  .message-ai .message-content {
    @apply glass-card rounded-2xl p-4 max-w-2xl;
  }

  .message-video {
    @apply glass-card rounded-2xl p-6 max-w-4xl;
  }

  .typing-indicator {
    @apply flex items-center space-x-2 text-cyan-400;
  }

  .typing-dot {
    @apply w-2 h-2 bg-cyan-400 rounded-full animate-pulse;
  }

  #messageInput:focus {
    border-color: var(--neon-cyan);
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
  }

  .video-preview-container {
    @apply relative rounded-xl overflow-hidden bg-black;
    @apply border-2 border-cyan-400 shadow-lg shadow-cyan-400/20;
  }

  .code-block {
    @apply bg-black bg-opacity-50 rounded-lg p-4 border border-cyan-400 border-opacity-30;
    @apply overflow-x-auto;
  }

  .code-block pre {
    @apply text-sm code-font text-gray-300;
  }
</style>
{% endblock %} {% block scripts %}
<script>
  let videoMode = false;
  let isGenerating = false;

  document.addEventListener("DOMContentLoaded", function () {
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const videoModeBtn = document.getElementById("videoModeBtn");
    const videoModeIndicator = document.getElementById("videoModeIndicator");
    const chatMessages = document.getElementById("chatMessages");
    const charCounter = document.getElementById("charCounter");
    const videoModal = document.getElementById("videoModal");
    const closeVideoModal = document.getElementById("closeVideoModal");

    // Auto-resize textarea
    messageInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = Math.min(this.scrollHeight, 150) + "px";

      // Update character counter
      const count = this.value.length;
      charCounter.textContent = `${count}/2000`;
      charCounter.style.color =
        count > 1800 ? "#ff6b6b" : count > 1500 ? "#ffa500" : "#6b7280";
    });

    // Keyboard shortcuts
    messageInput.addEventListener("keydown", function (e) {
      if (e.ctrlKey && e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
      if (e.shiftKey && e.key === "Enter") {
        // Allow new line
        return;
      }
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Send button click
    sendBtn.addEventListener("click", sendMessage);

    // Video mode toggle
    videoModeBtn.addEventListener("click", toggleVideoMode);

    // Quick action buttons
    document.querySelectorAll(".quick-action-btn").forEach((btn) => {
      btn.addEventListener("click", function () {
        const message = this.dataset.message;
        const isVideo = this.dataset.video === "true";

        if (isVideo) {
          videoMode = true;
          updateVideoModeUI();
        }

        messageInput.value = message;
        messageInput.focus();
        sendMessage();
      });
    });

    // Modal controls
    closeVideoModal.addEventListener("click", closeModal);
    videoModal.addEventListener("click", function (e) {
      if (e.target === this) closeModal();
    });

    // Functions
    function toggleVideoMode() {
      videoMode = !videoMode;
      updateVideoModeUI();
    }

    function updateVideoModeUI() {
      if (videoMode) {
        videoModeBtn.classList.remove("example-btn");
        videoModeBtn.classList.add("holo-btn");
        videoModeBtn.style.background =
          "linear-gradient(135deg, #8b5cf6, #a855f7)";
        videoModeIndicator.classList.remove("hidden");
      } else {
        videoModeBtn.classList.add("example-btn");
        videoModeBtn.classList.remove("holo-btn");
        videoModeBtn.style.background = "";
        videoModeIndicator.classList.add("hidden");
      }
    }

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message || isGenerating) return;

      // Add user message to chat
      addMessage(message, "user");

      const isVideoRequest = videoMode;

      // Clear input and reset video mode
      messageInput.value = "";
      messageInput.style.height = "auto";
      videoMode = false;
      updateVideoModeUI();

      // Show typing indicator
      showTypingIndicator();

      isGenerating = true;
      sendBtn.disabled = true;
      sendBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i><span class="hidden sm:inline">Sending...</span>';

      try {
        if (isVideoRequest) {
          await handleVideoRequest(message);
        } else {
          await handleChatRequest(message);
        }
      } catch (error) {
        console.error("Error:", error);
        addMessage("Sorry, I encountered an error. Please try again.", "ai");
      } finally {
        isGenerating = false;
        sendBtn.disabled = false;
        sendBtn.innerHTML =
          '<i class="fas fa-paper-plane"></i><span class="hidden sm:inline">Send</span>';
        hideTypingIndicator();
      }
    }

    async function handleChatRequest(message) {
      const response = await fetch("/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ message }),
      });

      const data = await response.json();

      if (response.ok) {
        addMessage(data.response, "ai");
      } else {
        addMessage("Sorry, I encountered an error. Please try again.", "ai");
      }
    }

    async function handleVideoRequest(message) {
      // Show modal with loading state
      showVideoModal("loading", message);

      const response = await fetch("/generate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ concept: message }),
      });

      const data = await response.json();

      if (response.ok) {
        // Add video message to chat
        addVideoMessage(data.video_url, data.code, message);
        // Update modal with success
        showVideoModal("success", message, data);
      } else {
        addMessage(`❌ Video generation failed: ${data.error}`, "ai");
        showVideoModal("error", message, data);
      }
    }

    function addMessage(content, sender) {
      const messageDiv = document.createElement("div");
      messageDiv.className = sender === "user" ? "message-user" : "message-ai";

      if (sender === "user") {
        messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="text-sm font-semibold mb-1">You</div>
                    <div>${escapeHtml(content)}</div>
                </div>
            `;
      } else {
        messageDiv.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-black text-sm"></i>
                </div>
                <div class="message-content">
                    <div class="text-sm text-cyan-400 font-semibold mb-1">MathsGPT</div>
                    <div class="text-white">${formatMessage(content)}</div>
                </div>
            `;
      }

      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    function addVideoMessage(videoUrl, code, concept) {
      const messageDiv = document.createElement("div");
      messageDiv.className = "message-ai";

      messageDiv.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-video text-black text-sm"></i>
            </div>
            <div class="message-video">
                <div class="text-sm text-purple-400 font-semibold mb-3">
                    <i class="fas fa-video mr-2"></i>Video Generated: ${escapeHtml(
                      concept
                    )}
                </div>
                
                <!-- Video Player -->
                <div class="video-preview-container mb-4">
                    <video controls class="w-full h-auto">
                        <source src="${videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 mb-4">
                    <a href="${videoUrl}" download class="holo-btn px-4 py-2 rounded-lg text-sm font-semibold flex items-center space-x-2">
                        <i class="fas fa-download"></i>
                        <span>Download</span>
                    </a>
                    <button onclick="showCode(this)" class="example-btn px-4 py-2 rounded-lg text-sm font-semibold flex items-center space-x-2">
                        <i class="fas fa-code"></i>
                        <span>View Code</span>
                    </button>
                    <button onclick="shareVideo('${videoUrl}')" class="example-btn px-4 py-2 rounded-lg text-sm font-semibold flex items-center space-x-2">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </button>
                </div>
                
                <!-- Hidden Code Block -->
                <div class="code-block hidden" data-code="${escapeHtml(code)}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-cyan-400 font-semibold">Generated Manim Code</span>
                        <button onclick="copyCode(this)" class="text-cyan-400 hover:text-white text-sm">
                            <i class="fas fa-copy mr-1"></i>Copy
                        </button>
                    </div>
                    <pre><code class="language-python">${escapeHtml(
                      code
                    )}</code></pre>
                </div>
            </div>
        `;

      chatMessages.appendChild(messageDiv);
      scrollToBottom();

      // Highlight code syntax
      if (window.Prism) {
        Prism.highlightAllUnder(messageDiv);
      }
    }

    function showTypingIndicator() {
      const typingDiv = document.createElement("div");
      typingDiv.id = "typingIndicator";
      typingDiv.className = "message-ai";
      typingDiv.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-robot text-black text-sm"></i>
            </div>
            <div class="glass-card rounded-2xl p-4">
                <div class="typing-indicator">
                    <span class="text-cyan-400 text-sm">MathsGPT is typing</span>
                    <div class="typing-dot" style="animation-delay: 0s;"></div>
                    <div class="typing-dot" style="animation-delay: 0.2s;"></div>
                    <div class="typing-dot" style="animation-delay: 0.4s;"></div>
                </div>
            </div>
        `;

      chatMessages.appendChild(typingDiv);
      scrollToBottom();
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById("typingIndicator");
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function showVideoModal(state, concept, data = null) {
      const modal = document.getElementById("videoModal");
      const content = document.getElementById("videoModalContent");

      if (state === "loading") {
        content.innerHTML = `
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-6"></div>
                    <h4 class="text-xl font-semibold text-cyan-400 mb-2">Generating Video</h4>
                    <p class="text-gray-300 mb-4">Creating animation for: "${escapeHtml(
                      concept
                    )}"</p>
                    <div class="space-y-2 text-sm text-gray-400">
                        <div class="flex items-center justify-center space-x-2">
                            <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
                            <span>Analyzing concept...</span>
                        </div>
                    </div>
                </div>
            `;
      } else if (state === "success") {
        content.innerHTML = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-500 bg-opacity-20 flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-400 text-2xl"></i>
                    </div>
                    <h4 class="text-xl font-semibold text-green-400 mb-2">Video Generated Successfully!</h4>
                    <p class="text-gray-300">Your animation has been created and added to the chat.</p>
                </div>
                <div class="flex justify-center space-x-4">
                    <button onclick="closeModal()" class="holo-btn px-6 py-3 rounded-xl font-semibold">
                        Continue Chatting
                    </button>
                    <a href="${data.video_url}" download class="example-btn px-6 py-3 rounded-xl font-semibold">
                        Download Video
                    </a>
                </div>
            `;
      } else if (state === "error") {
        content.innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500 bg-opacity-20 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                    </div>
                    <h4 class="text-xl font-semibold text-red-400 mb-2">Generation Failed</h4>
                    <p class="text-gray-300 mb-4">${
                      data?.error ||
                      "An error occurred while generating the video."
                    }</p>
                    <button onclick="closeModal()" class="holo-btn px-6 py-3 rounded-xl font-semibold">
                        Try Again
                    </button>
                </div>
            `;
      }

      modal.classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("videoModal").classList.add("hidden");
    }

    window.closeModal = closeModal;

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatMessage(content) {
      // Basic markdown-like formatting
      return content
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/\*(.*?)\*/g, "<em>$1</em>")
        .replace(/`(.*?)`/g, '<code class="bg-gray-800 px-1 rounded">$1</code>')
        .replace(/\n/g, "<br>");
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Global functions for buttons
    window.showCode = function (button) {
      const codeBlock = button
        .closest(".message-video")
        .querySelector(".code-block");
      if (codeBlock.classList.contains("hidden")) {
        codeBlock.classList.remove("hidden");
        button.innerHTML =
          '<i class="fas fa-eye-slash"></i><span>Hide Code</span>';
      } else {
        codeBlock.classList.add("hidden");
        button.innerHTML = '<i class="fas fa-code"></i><span>View Code</span>';
      }
    };

    window.copyCode = function (button) {
      const codeBlock = button.closest(".code-block");
      const code = codeBlock.dataset.code;

      navigator.clipboard.writeText(code).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
        button.classList.add("text-green-400");

        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove("text-green-400");
        }, 2000);
      });
    };

    window.shareVideo = function (videoUrl) {
      if (navigator.share) {
        navigator.share({
          title: "MathsGPT Animation",
          text: "Check out this mathematical animation!",
          url: videoUrl,
        });
      } else {
        navigator.clipboard.writeText(videoUrl).then(() => {
          alert("Video URL copied to clipboard!");
        });
      }
    };

    // Initialize focus
    messageInput.focus();
  });
</script>
{% endblock %}
